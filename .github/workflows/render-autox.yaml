name: ğŸš€ Auto Tweet Render Keep-Alive

on:
  schedule:
    - cron: '50,57 9,14,20 * * *'
  

  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode - ping service now'
        required: false
        default: 'false'

env:
  SERVICE_URL: https://autox-tro9.onrender.com

jobs:
  keep-service-alive:
    name: ğŸ“¡ Ping Render Service
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“ Ping Auto-Tweet Service
        id: ping
        run: |
          echo "ğŸŒŸ Starting keep-alive ping at $(date -u)"
          echo "ğŸ¯ Target: $SERVICE_URL/ping"
          
          # First ping attempt
          echo "ğŸ”„ Attempting first ping..."
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\nTIME_TOTAL:%{time_total}" \
            -H "User-Agent: GitHub-Actions-KeepAlive/1.0" \
            -H "Accept: application/json" \
            --max-time 30 \
            --retry 2 \
            --retry-delay 5 \
            $SERVICE_URL/ping || echo "CURL_FAILED")
          
          # Parse response
          if [[ "$response" == *"CURL_FAILED"* ]]; then
            echo "âŒ Curl command failed"
            exit_code=1
          else
            http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d: -f2)
            time_total=$(echo "$response" | grep "TIME_TOTAL" | cut -d: -f2)
            response_body=$(echo "$response" | sed '/HTTP_STATUS/d' | sed '/TIME_TOTAL/d')
            
            echo "ğŸ“Š HTTP Status: $http_status"
            echo "â±ï¸  Response Time: ${time_total}s"
            echo "ğŸ“ Response Body: $response_body"
            
            if [ "$http_status" = "200" ]; then
              echo "âœ… Service is awake and healthy!"
              exit_code=0
            elif [ "$http_status" = "503" ]; then
              echo "ğŸ’¤ Service was hibernated - wake-up triggered"
              echo "ğŸ”„ This is expected behavior for free Render services"
              exit_code=0
            else
              echo "âš ï¸  Unexpected HTTP status: $http_status"
              exit_code=1
            fi
          fi
          
          # Set outputs for next step
          echo "http_status=$http_status" >> $GITHUB_OUTPUT
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

      - name: ğŸ” Health Check (Optional Second Ping)
        if: steps.ping.outputs.http_status == '503'
        run: |
          echo "â³ Service was hibernated, waiting 45 seconds for wake-up..."
          sleep 45
          
          echo "ğŸ”„ Performing health check ping..."
          health_response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -H "User-Agent: GitHub-Actions-HealthCheck/1.0" \
            --max-time 30 \
            $SERVICE_URL/ping || echo "HEALTH_CHECK_FAILED")
          
          if [[ "$health_response" == *"HEALTH_CHECK_FAILED"* ]]; then
            echo "âš ï¸  Health check failed, but service should be waking up"
          else
            health_status=$(echo "$health_response" | grep "HTTP_STATUS" | cut -d: -f2)
            echo "ğŸ¥ Health Check Status: $health_status"
            
            if [ "$health_status" = "200" ]; then
              echo "ğŸ‰ Service is now fully awake!"
            else
              echo "â³ Service is still starting up (this is normal)"
            fi
          fi

      - name: ğŸ“ˆ Log Summary
        if: always()
        run: |
          echo "================================================"
          echo "ğŸš€ Auto Tweet Keep-Alive Summary"
          echo "================================================"
          echo "ğŸ• Run Time: $(date -u)"
          echo "ğŸ¯ Service: $SERVICE_URL"
          echo "ğŸ“Š Status: ${{ steps.ping.outputs.http_status || 'Unknown' }}"
          echo "ğŸ”„ Next scheduled tweets:"
          echo "   â€¢ 10:00 AM UTC - Tech Tips"
          echo "   â€¢ 15:00 PM UTC - SaaS Journey" 
          echo "   â€¢ 21:00 PM UTC - Tech Tips"
          echo "================================================"
          
          if [ "${{ steps.ping.outputs.exit_code }}" = "0" ]; then
            echo "âœ… Keep-alive mission successful!"
          else
            echo "âš ï¸  Keep-alive completed with warnings"
          fi